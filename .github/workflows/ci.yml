name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  validate:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Parse check entrypoint + all src scripts
        shell: pwsh
        run: |
          $files = @()
          $files += Resolve-Path .\WinGet-PSADT-GUI.ps1
          $files += Get-ChildItem -Path .\src -Recurse -Filter *.ps1 | Select-Object -ExpandProperty FullName
          if (-not $files -or $files.Count -eq 0) { throw "No PowerShell files found to validate." }

          $hadErrors = $false
          foreach ($f in $files) {
            $tokens = $null
            $errors = $null
            [System.Management.Automation.Language.Parser]::ParseFile($f,[ref]$tokens,[ref]$errors) | Out-Null
            if ($errors -and $errors.Count -gt 0) {
              Write-Host "Parse errors in: $f"
              $errors | ForEach-Object { Write-Host ("  - " + $_.Message) }
              $hadErrors = $true
            }
          }
          if ($hadErrors) { throw "PowerShell parse validation failed." }

      - name: Validate required project files
        shell: pwsh
        run: |
          $required = @(
            '.\WinGet-PSADT-GUI.ps1',
            '.\Start-WinGetPsadtTool.cmd',
            '.\src\GUI\MainHost.ps1',
            '.\src\Core\Initialize.ps1'
          )
          foreach ($p in $required) {
            if (-not (Test-Path $p)) { throw "Missing required file: $p" }
          }
